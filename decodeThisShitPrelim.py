#!/usr/bin/python

import binascii
import sys
import struct

TYPE_VARINT = 0
TYPE_64 = 1
TYPE_LENGTHDELIM = 2
TYPE_STARTGROUP = 3
TYPE_ENDGROUP = 4
TYPE_32 = 5


def getVarintPos(stream):
    result = 0
    shifts = 0
    pos = 1
    for i in stream:
        result = result | ((ord(i)&0x7f) << shifts)
        if not (ord(i)&0x80):
            return result,pos
        shifts = shifts+7
        pos = pos+1

def getLengthdelimPos(stream):
    length,pos = getVarintPos(stream)
    stream = stream[pos:]
    string = stream[0:length]
    return string,pos+length

def getTagType(i):
    return (i>>3,i&0x07)

def getTypeName(i):
    if i == TYPE_VARINT:
        return "varint"
    elif i == TYPE_64:
        return "64 bit"
    elif i == TYPE_LENGTHDELIM:
        return "length delim"
    elif i == TYPE_32:
        return "32 bit"
    else:
        return "WTF"

def genDecodeProtoBuff(protoBin, indentLevel = 0):
    allsGood = True
    while allsGood:
        if len(protoBin) == 0:
            return 1
        currentTagInt,pos = getVarintPos(protoBin)
        protoBin = protoBin[pos:]
        currentTag,currentType = getTagType(currentTagInt)
        if currentType == TYPE_LENGTHDELIM:
            data,pos = getLengthdelimPos(protoBin)
            protoBin = protoBin[pos:]
            print "    " * indentLevel + "Current Tag: " + str(currentTag)
            print "    " * indentLevel + "Current Type: " + getTypeName(currentType)
            print "    " * indentLevel + "Current Data: " + data
            print "    " * indentLevel + "Current Data Hex: " + binascii.hexlify(data)
            print "    " * indentLevel + "*******Digging In**********"
            genDecodeProtoBuff(data, indentLevel + 1)
            print "    " * indentLevel + "***************************"
        elif currentType == TYPE_VARINT:
            data,pos = getVarintPos(protoBin)
            protoBin = protoBin[pos:]
            print "    " * indentLevel + "Current Tag: " + str(currentTag)
            print "    " * indentLevel + "Current Type: " + getTypeName(currentType)
            print "    " * indentLevel + "Current Data: " + str(data)
        else:
            print "    " * indentLevel + "OMFG:" + str(currentType) + " " + getTypeName(currentType)
            allsGood = False


#proto="0A2463383939326534352D396434302D343335612D623132662D39623461306463656130663210601A5608B7D3948D949898A334124031373935366361656139626362303462656361353236326562643337646331326334333265396231636136366665633534393134373037613832646234323962180020012899D20D300022156967616E64726F69646E7340676D61696C2E636F6D2A5E0A2A0A1333393131303830303433333133333938393532121333393131303830303433333133333938393532180128A889C2EEBDD2BCA3363224636F6D2E676F6F676C652E616E64726F69642E617070732E77616C6C65746E666372656C300038014013520908021080A0CAF5D32658006A2A479050444791007833000260027441953612000000000000000011220C32373434310000000000000000700178018001FCB2D2DDAC268801BFAD97E7AC26"
#proto2 = "08b7d3948d949898a334124031373935366361656139626362303462656361353236326562643337646331326334333265396231636136366665633534393134373037613832646234323962180020012899d20d3000"
#proto3="0A2437306561643734632D313231662D346335662D623933332D63333337373866623734333310211A5A08D7B9F4E0ADD5F490D401124038396333346130346639393938666263353964343531656435353062643861323635356337333438613533643130623239346263656163346239626662356661180020012899A0B22930E0A71222126E7334676A616B6540676D61696C2E636F6D2A5E0A2A0A1334333836343932333337353131383131383933121334333836343932333337353131383131383933180128B596F59AA5F1FCEF3C3224636F6D2E676F6F676C652E616E64726F69642E617070732E77616C6C65746E666372656C3000380140075209080210ACB7B99CD42658006A2A479050444791007833001016021743954638000000000000000007451C32313734330000000000000000700178018001A6F7EAB0B426880184AD88FBD3269001019A0100"
#proto4="0A2463383939326534352D396434302D343335612D623132662D39623461306463656130663210511A5808BF8C8BD0CB9EE3CCEE011240626366333631363730643437643233363965306434306665343834656430393338323031663238323662383535393139633961346666613665353136333537621800200128FDAFAD1C300022156967616E64726F69646E7340676D61696C2E636F6D2A5E0A2A0A1333393131303830303433333133333938393532121333393131303830303433333133333938393532180128A889C2EEBDD2BCA3363224636F6D2E676F6F676C652E616E64726F69642E617070732E77616C6C65746E666372656C30003801401352090802109BAB9E9EB22658006A2A479050444791007833000260027441953612000000000000000011220C32373434310000000000000000700178018001FCB2D2DDAC268801BFAD97E7AC26"
protoBin = binascii.unhexlify(sys.argv[1])


    
genDecodeProtoBuff(protoBin) 
